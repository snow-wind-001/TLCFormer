<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 650 350" width="650" height="350">
  <defs>
    <style>
      .title { font: bold 16px Arial; fill: #1a1a2e; }
      .module { font: bold 12px Arial; fill: white; }
      .label { font: 11px Arial; fill: #333; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
    </marker>
    <linearGradient id="grad-input" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#607D8B"/>
      <stop offset="100%" style="stop-color:#78909C"/>
    </linearGradient>
    <linearGradient id="grad-max" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#F44336"/>
      <stop offset="100%" style="stop-color:#EF5350"/>
    </linearGradient>
    <linearGradient id="grad-avg" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#2196F3"/>
      <stop offset="100%" style="stop-color:#42A5F5"/>
    </linearGradient>
    <linearGradient id="grad-concat" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#FF9800"/>
      <stop offset="100%" style="stop-color:#FFB74D"/>
    </linearGradient>
    <linearGradient id="grad-conv" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#3F51B5"/>
      <stop offset="100%" style="stop-color:#5C6BC0"/>
    </linearGradient>
    <linearGradient id="grad-output" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#4CAF50"/>
      <stop offset="100%" style="stop-color:#66BB6A"/>
    </linearGradient>
  </defs>
  
  <rect width="650" height="350" fill="#fafafa"/>
  <text x="325" y="30" text-anchor="middle" class="title">Hybrid Energy-Preserving Token Mixer</text>
  
  <g transform="translate(30, 80)">
    <rect x="0" y="40" width="70" height="60" rx="5" fill="url(#grad-input)" stroke="#455A64" stroke-width="2"/>
    <text x="35" y="75" text-anchor="middle" class="module">X</text>
    <text x="35" y="120" text-anchor="middle" class="label">(B,N,D)</text>
  </g>
  
  <path d="M 100 110 L 140 70" stroke="#666" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 100 110 L 140 150" stroke="#666" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  
  <g transform="translate(140, 40)">
    <rect x="0" y="0" width="90" height="60" rx="5" fill="url(#grad-max)" stroke="#D32F2F" stroke-width="2"/>
    <text x="45" y="25" text-anchor="middle" class="module">MaxPool2d</text>
    <text x="45" y="45" text-anchor="middle" style="font: 10px Arial; fill: white;">k=3, s=1</text>
    <text x="45" y="75" text-anchor="middle" class="label">P_max</text>
    <text x="45" y="90" text-anchor="middle" style="font: 9px Arial; fill: #F44336;">Preserve extrema</text>
  </g>
  
  <g transform="translate(140, 120)">
    <rect x="0" y="0" width="90" height="60" rx="5" fill="url(#grad-avg)" stroke="#1976D2" stroke-width="2"/>
    <text x="45" y="25" text-anchor="middle" class="module">AvgPool2d</text>
    <text x="45" y="45" text-anchor="middle" style="font: 10px Arial; fill: white;">k=3, s=1</text>
    <text x="45" y="75" text-anchor="middle" class="label">P_avg</text>
    <text x="45" y="90" text-anchor="middle" style="font: 9px Arial; fill: #2196F3;">Background texture</text>
  </g>
  
  <g transform="translate(270, 70)">
    <rect x="0" y="0" width="80" height="80" rx="5" fill="url(#grad-concat)" stroke="#F57C00" stroke-width="2"/>
    <text x="40" y="35" text-anchor="middle" class="module">Concat</text>
    <text x="40" y="55" text-anchor="middle" style="font: 10px Arial; fill: white;">dim=1</text>
    <text x="40" y="100" text-anchor="middle" class="label">P_hybrid</text>
    <text x="40" y="115" text-anchor="middle" style="font: 9px Arial; fill: #666;">(B,2D,H,W)</text>
  </g>
  
  <path d="M 230 70 L 270 95" stroke="#666" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 230 150 L 270 125" stroke="#666" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  
  <g transform="translate(390, 70)">
    <rect x="0" y="0" width="90" height="80" rx="5" fill="url(#grad-conv)" stroke="#303F9F" stroke-width="2"/>
    <text x="45" y="25" text-anchor="middle" class="module">Conv1x1</text>
    <text x="45" y="42" text-anchor="middle" style="font: 10px Arial; fill: white;">2D -&gt; D</text>
    <text x="45" y="58" text-anchor="middle" style="font: 10px Arial; fill: white;">+BN+GELU</text>
    <text x="45" y="100" text-anchor="middle" class="label">X_mixed</text>
  </g>
  
  <path d="M 350 110 L 390 110" stroke="#666" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  
  <path d="M 65 140 L 65 230 L 530 230 L 530 170" stroke="#4CAF50" stroke-width="2" stroke-dasharray="5,5" fill="none"/>
  <text x="280" y="250" text-anchor="middle" style="font: 11px Arial; fill: #4CAF50;">Skip Connection (Residual)</text>
  
  <g transform="translate(520, 130)">
    <circle cx="25" cy="25" r="20" fill="url(#grad-output)" stroke="#388E3C" stroke-width="2"/>
    <text x="25" y="30" text-anchor="middle" class="module">+</text>
  </g>
  
  <path d="M 480 110 L 520 145" stroke="#666" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  
  <g transform="translate(580, 115)">
    <rect x="0" y="10" width="50" height="50" rx="5" fill="url(#grad-output)" stroke="#388E3C" stroke-width="2"/>
    <text x="25" y="40" text-anchor="middle" class="module">X_out</text>
  </g>
  
  <path d="M 560 155 L 580 150" stroke="#666" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  
  <g transform="translate(50, 275)">
    <rect x="0" y="0" width="550" height="60" rx="8" fill="white" stroke="#3F51B5" stroke-width="2"/>
    <text x="275" y="22" text-anchor="middle" class="title" style="fill: #3F51B5;">Energy-Preserving Fusion</text>
    <text x="275" y="48" text-anchor="middle" style="font: 14px Times; fill: #333;">X_out = X + GELU(Conv_1x1(Concat(MaxPool(X), AvgPool(X))))</text>
  </g>
</svg>
